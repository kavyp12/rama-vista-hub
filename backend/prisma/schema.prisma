generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  sales_manager
  sales_agent
}

enum LeadStage {
  new
  contacted
  site_visit
  negotiation
  token
  closed
  lost
  completed
  
}

enum Temperature {
  hot
  warm
  cold
}

enum PropertyType {
  apartment
  villa
  plot
  commercial
  penthouse
  townhouse
}

enum PropertyStatus {
  available
  booked
  sold
}

enum ProjectStatus {
  active
  upcoming
  completed
  on_hold
}

enum DealStage {
  negotiation
  token
  documentation
  closed
  lost
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
  overdue
}

enum DocumentStatus {
  draft
  pending_signature
  signed
  expired
  sent
}



enum SiteVisitStatus {
  scheduled
  rescheduled   // <--- ADD THIS
  completed
  cancelled
}

enum CallStatus {
  connected_positive
  connected_callback
  not_connected
  not_interested
}

enum TaskStatus {
  pending
  in_progress
  completed
  cancelled
}

enum CampaignStatus {
  draft
  scheduled
  active
  completed
  paused
}

model DocumentSignature {
  id            String   @id @default(uuid())
  documentId    String   @map("document_id")
  signerId      String   @map("signer_id")
  signatureData String   @map("signature_data")
  signerName    String   @map("signer_name")
  signerRole    String?  @map("signer_role")
  ipAddress     String?  @map("ip_address")
  signedAt      DateTime @default(now()) @map("signed_at")

  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  signer        User     @relation("DocumentSignatures", fields: [signerId], references: [id])

  @@map("document_signatures")
}

model PaymentReminder {
  id           String   @id @default(uuid())
  paymentId    String   @map("payment_id")
  sentBy       String   @map("sent_by")
  sentAt       DateTime @default(now()) @map("sent_at")
  reminderType String   @map("reminder_type")
  status       String   @default("sent")

  payment      Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  sender       User     @relation("SentReminders", fields: [sentBy], references: [id])

  @@map("payment_reminders")
}


model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  fullName      String   @map("full_name")
  role          UserRole @default(sales_agent)
  avatarUrl     String?  @map("avatar_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  assignedLeads        Lead[]                @relation("AssignedTo")
  assignedDeals        Deal[]                @relation("AssignedTo")
  callLogs             CallLog[]
  followUpTasks        FollowUpTask[]
  activityLogs         ActivityLog[]
  documentsCreated     Document[]            @relation("CreatedBy")
  campaignsCreated     MarketingCampaign[]   @relation("CreatedBy")
  siteVisitsConducted  SiteVisit[]           @relation("ConductedBy")
  documentSignatures   DocumentSignature[]   @relation("DocumentSignatures")
  sentReminders        PaymentReminder[]     @relation("SentReminders")

  lastContactedAt DateTime? @map("last_contacted_at")
  leadScore       Int?      @default(0) @map("lead_score")
  
  // ✅ ADDED: Opposite relation for PropertyRecommendation
  recommendationsSent PropertyRecommendation[] @relation("RecommendedBy")

  @@map("users")
}

model Lead {
  id                String      @id @default(uuid())
  name              String
  email             String?
  phone             String
  source            String
  stage             LeadStage   @default(new)
  temperature       Temperature @default(warm)
  budgetMin         Float?      @map("budget_min")
  budgetMax         Float?      @map("budget_max")
  preferredLocation String?     @map("preferred_location")
  notes             String?
  nextFollowupAt    DateTime?   @map("next_followup_at")
  assignedToId      String?     @map("assigned_to")

  lastContactedAt   DateTime?   @map("last_contacted_at")
  
  brokerId          String?     @map("broker_id")
  broker            Broker?     @relation(fields: [brokerId], references: [id])

  projectId         String?     @map("project_id")
  project           Project?    @relation(fields: [projectId], references: [id])

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  assignedTo    User?         @relation("AssignedTo", fields: [assignedToId], references: [id])
  deals         Deal[]
  callLogs      CallLog[]
  siteVisits    SiteVisit[]
  documents     Document[]
  payments      Payment[]
  followUpTasks FollowUpTask[]
  
  // ✅ ADDED: Opposite relation for PropertyRecommendation
  propertyRecommendations PropertyRecommendation[]

  @@map("leads")
}

model Property {
  id           String         @id @default(uuid())
  title        String
  propertyType PropertyType   @map("property_type")
  location     String
  city         String?
  bedrooms     Int?
  bathrooms    Int?
  areaSqft     Float?         @map("area_sqft")
  price        Float
  status       PropertyStatus @default(available)
  description  String?
  features     String[]
  imageUrls    String[]       @map("image_urls")
  projectId    String?        @map("project_id")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  project    Project?    @relation(fields: [projectId], references: [id])
  deals      Deal[]
  siteVisits SiteVisit[]
  documents  Document[]
  payments   Payment[]

  // ✅ ADDED: Opposite relation for PropertyRecommendation
  recommendations PropertyRecommendation[]

  @@map("properties")
}

model PropertyRecommendation {
  id            String   @id @default(uuid())
  leadId        String   @map("lead_id")
  propertyId    String   @map("property_id")
  recommendedBy String   @map("recommended_by")
  sentAt        DateTime @default(now()) @map("sent_at")
  notes         String?

  lead        Lead     @relation(fields: [leadId], references: [id])
  property    Property @relation(fields: [propertyId], references: [id])
  recommender User     @relation("RecommendedBy", fields: [recommendedBy], references: [id])

  @@map("property_recommendations")
}

model Project {
  id             String        @id @default(uuid())
  websiteId      String?       @unique @map("website_id")
  category       String        @default("residential")
  state          String?
  village        String?
  taluka         String?
  district       String?
  plotArea       Float?        @map("plot_area")
  surveyNumber   String?       @map("survey_number")
  propertyType   String?       @map("property_type")      
  transactionType String?      @map("transaction_type")

  name           String
  location       String
  city           String?
  developer      String?
  status         ProjectStatus @default(active)
  priceDisplay   String?       @map("price_display") 
  totalUnits     Int?          @map("total_units")
  availableUnits Int?          @map("available_units")
  minPrice       Float?        @map("min_price")
  maxPrice       Float?        @map("max_price")
  description    String?
  amenities      String[]
  imageUrls      String[]      @map("image_urls")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  properties     Property[]
  siteVisits     SiteVisit[]
  documents      Document[]
  leads          Lead[]

  @@map("projects")
}

model Deal {
  id                String    @id @default(uuid())
  leadId            String    @map("lead_id")
  propertyId        String?   @map("property_id")
  dealValue         Float     @map("deal_value")
  probability       Int?
  stage             DealStage @default(negotiation)
  expectedCloseDate DateTime? @map("expected_close_date")
  closedAt          DateTime? @map("closed_at")
  notes             String?
  assignedToId      String?   @map("assigned_to")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  lead       Lead      @relation(fields: [leadId], references: [id])
  property   Property? @relation(fields: [propertyId], references: [id])
  assignedTo User?     @relation("AssignedTo", fields: [assignedToId], references: [id])
  payments   Payment[]
  documents  Document[]

  @@map("deals")
}

model Payment {
  id                 String        @id @default(uuid())
  leadId             String?       @map("lead_id")
  dealId             String?       @map("deal_id")
  propertyId         String?       @map("property_id")
  amount             Float
  paymentType        String        @map("payment_type")
  paymentMethod      String?       @map("payment_method")
  status             PaymentStatus @default(pending)
  dueDate            DateTime?     @map("due_date")
  paidAt             DateTime?     @map("paid_at")
  referenceNumber    String?       @map("reference_number")
  notes              String?
  installmentNumber  Int?          @map("installment_number")
  totalInstallments  Int?          @map("total_installments")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  lead      Lead?              @relation(fields: [leadId], references: [id])
  deal      Deal?              @relation(fields: [dealId], references: [id])
  property  Property?          @relation(fields: [propertyId], references: [id])
  reminders PaymentReminder[]

  @@map("payments")
}

model Document {
  id           String         @id @default(uuid())
  name         String
  type         String
  fileUrl      String?        @map("file_url")
  leadId       String?        @map("lead_id")
  propertyId   String?        @map("property_id")
  projectId    String?        @map("project_id")
  dealId       String?        @map("deal_id")
  status       DocumentStatus @default(draft)
  signedAt     DateTime?      @map("signed_at")
  expiresAt    DateTime?      @map("expires_at")
  documentData Json?          @map("document_data")
  createdBy    String         @map("created_by")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  lead       Lead?                @relation(fields: [leadId], references: [id])
  property   Property?            @relation(fields: [propertyId], references: [id])
  project    Project?             @relation(fields: [projectId], references: [id])
  deal       Deal?                @relation(fields: [dealId], references: [id])
  creator    User                 @relation("CreatedBy", fields: [createdBy], references: [id])
  signatures DocumentSignature[]

  @@map("documents")
}

model Broker {
  id             String   @id @default(uuid())
  name           String
  agencyName     String?  @map("agency_name")
  email          String?
  phone          String   @unique
  reraId         String?  @map("rera_id")
  location       String?
  commissionRate Float?   @default(0) @map("commission_rate") 
  leads          Lead[]
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("brokers")
}

model SiteVisit {
  id          String          @id @default(uuid())
  leadId      String          @map("lead_id")
  propertyId  String?         @map("property_id")
  projectId   String?         @map("project_id")
  scheduledAt DateTime        @map("scheduled_at")
  status      SiteVisitStatus @default(scheduled)
  feedback    String?
  rating      Int?
  conductedBy String?         @map("conducted_by")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  lead      Lead      @relation(fields: [leadId], references: [id])
  property  Property? @relation(fields: [propertyId], references: [id])
  project   Project?  @relation(fields: [projectId], references: [id])
  conductor User?     @relation("ConductedBy", fields: [conductedBy], references: [id])

  @@map("site_visits")
}
model CallLog {
  id                   String     @id @default(uuid())
  leadId               String     @map("lead_id")
  agentId              String     @map("agent_id")
  callStatus           CallStatus @map("call_status")
  callDate             DateTime   @default(now()) @map("call_date")
  callDuration         Int?       @map("call_duration")
  notes                String?
  callbackScheduledAt  DateTime?  @map("callback_scheduled_at")
  rejectionReason      String?    @map("rejection_reason")
  retryCount           Int        @default(0) @map("retry_count")
  
  // ✅ NEW FIELDS FOR FILTERING
  isArchived           Boolean    @default(false) @map("is_archived")
  deletedAt            DateTime?  @map("deleted_at") // For soft delete

  createdAt            DateTime   @default(now()) @map("created_at")

  lead  Lead @relation(fields: [leadId], references: [id])
  agent User @relation(fields: [agentId], references: [id])

  @@map("call_logs")
}

model FollowUpTask {
  id          String     @id @default(uuid())
  leadId      String     @map("lead_id")
  agentId     String     @map("agent_id")
  taskType    String     @map("task_type")
  scheduledAt DateTime   @map("scheduled_at")
  status      TaskStatus @default(pending)
  notes       String?
  completedAt DateTime?  @map("completed_at")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  lead  Lead @relation(fields: [leadId], references: [id])
  agent User @relation(fields: [agentId], references: [id])

  @@map("follow_up_tasks")
}

model MarketingCampaign {
  id              String           @id @default(uuid())
  name            String
  type            String
  status          CampaignStatus   @default(draft)
  targetAudience  String?          @map("target_audience")
  messageTemplate String?          @map("message_template")
  scheduledAt     DateTime?        @map("scheduled_at")
  sentCount       Int              @default(0) @map("sent_count")
  openedCount     Int              @default(0) @map("opened_count")
  clickedCount    Int              @default(0) @map("clicked_count")
  convertedCount  Int              @default(0) @map("converted_count")
  createdBy       String           @map("created_by")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  creator User @relation("CreatedBy", fields: [createdBy], references: [id])

  @@map("marketing_campaigns")
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}